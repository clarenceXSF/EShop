@{
    ViewBag.Title = "添加图书类型";
}
@section featured {
    <div class="am-cf am-padding">
        <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">@ViewBag.Title</strong></div>
    </div>
}
@section scripts {
<script src="~/js/admin/AlertMess.js"></script>
<script src="~/js/admin/doType.js"></script>
}
<div class="am-tabs" data-am-tabs>
    <ul class="am-tabs-nav am-nav am-nav-tabs">
        <li><a>信息录入</a></li>
    </ul>
    <form class="am-form am-form-horizontal am-text-primary" id="AddForm" action="@Url.Content("~/Type/AddNewType")" method="POST">
        <div class="am-margin-top am-form-group">
            <label class="am-u-sm-2 am-text-right am-form-label">类型代码：</label>
            <div class="am-u-sm-5 am-u-end">
                <input type="text" id="typeCode" name="typeCode" class="am-round am-text-center" placeholder="请输入类型代码" />
                <div>
                    &nbsp;
                    <div id="typeCode_prompt"></div>
                </div>
            </div>
        </div>
        <div class="am-form-group">
            <label class="am-u-sm-2 am-form-label">类型名称：</label>
            <div class="am-u-sm-5 am-u-end">
                <input type="text" id="typeName" name="typeName" class="am-round am-text-center" placeholder="请输入类型名称" />
                <div>
                    &nbsp;
                    <div id="typeName_prompt"></div>
                </div>
            </div>
        </div>
        <div class="am-form-group">
            <label class="am-u-sm-2 am-form-label">目录图片：</label>
            @*<div class="am-u-sm-5 am-u-end">
                <input name="upImg" style="width:350px;height:25px;" size="38" type="file" /><input type="submit" value="上传" />
                <div>
                    &nbsp;
                    <div id="upImg_prompt"><img alt="" style="display:none;" id="result" src="" /></div>
                </div>
            </div>*@
            @*<div class="wraper">
                <div class="btn-wraper">
                    <input type="button" value="选择文件..." id="browse" />
                </div>
                <ul id="file-list"></ul>
            </div>*@
            <div class="am-u-sm-5 am-u-end">
                <input type="button" value="选择文件..." id="browse" /><div>* 300*300</div>
                <div>
                    &nbsp;<div id="upName"></div>
                    @*<div id="upImg"></div>*@
                </div>
            </div>
            <div class="am-u-sm-5" id="upImg"></div>
        </div>
        <br />
        <div class="am-u-sm-10  am-u-sm-offset-2">
            <button type="button" class="am-btn am-btn-primary" onclick="location.href = 'Index';">
                <span class="am-icon-refresh"></span> 返 回
            </button>
            <button type="submit" class="am-btn am-btn-primary" style="margin-left: 10%">
                <span class="am-icon-external-link"></span> 提 交
            </button>
        </div>
    </form>
</div>
<script src="~/js/lib/plUpload/plupload.full.min.js"></script>
<script>
    var uploader = new plupload.Uploader({ //实例化一个plupload上传对象
        browse_button: 'browse',
        url: 'upload.html',
        flash_swf_url: '~/js/lib/plUpload/Moxie.swf',
        silverlight_xap_url: '~/js/lib/plUpload/Moxie.xap',
        filters: {
            mime_types: [ //只允许上传图片文件
              { title: "图片文件", extensions: "jpg,gif,png" }
            ],
            prevent_duplicates: true ,//不允许选取重复文件
            multi_selection: false//单文件
        }
    });
    uploader.init(); //初始化

    //绑定文件添加进队列事件
    uploader.bind('FilesAdded', function (uploader, files) {
        //for (var i = 0, len = files.length; i < len; i++) {
        //    var file_name = files[i].name; //文件名
        //    //构造html来更新UI
        //    var html = '<li id="file-' + files[i].id + '"><p class="file-name">' + file_name + '</p><p class="progress"></p></li>';
        //    $(html).appendTo('#file-list');
        //    !function (i) {
        //        previewImage(files[i], function (imgsrc) {
        //            $('#file-' + files[i].id).append('<img src="' + imgsrc + '" />');
        //        })
        //    }(i);
        //}
        $.each(uploader.files, function (i, file) {
            if (uploader.files.length <= 1) {
                return;
            }
            uploader.removeFile(file);
        });
        var file_name = files[0].name; //文件名
        //var html = 'img name: ' + file_name;
        //$(html).appendTo('#upName');
        $('#upName').html('img name: ' + file_name);
        previewImage(files[0], function (imgsrc) {
            $('#upImg').empty();
            $('#upImg').append('<img src="' + imgsrc + '" width="180" height="200"/>');
        })
    });
    //plupload中为我们提供了mOxie对象
    //有关mOxie的介绍和说明请看：https://github.com/moxiecode/moxie/wiki/API
    function previewImage(file, callback) {//file为plupload事件监听函数参数中的file对象,callback为预览图片准备完成的回调函数
        if (!file || !/image\//.test(file.type)) return; //确保文件是图片
        if (file.type == 'image/gif') {//gif使用FileReader进行预览,因为mOxie.Image只支持jpg和png
            var fr = new mOxie.FileReader();
            fr.onload = function () {
                callback(fr.result);
                fr.destroy();
                fr = null;
            }
            fr.readAsDataURL(file.getSource());
        } else {
            var preloader = new mOxie.Image();
            preloader.onload = function () {
                preloader.downsize(300, 300);//先压缩一下要预览的图片,宽300，高300
                var imgsrc = preloader.type == 'image/jpeg' ? preloader.getAsDataURL('image/jpeg', 80) : preloader.getAsDataURL(); //得到图片src,实质为一个base64编码的数据
                callback && callback(imgsrc); //callback传入的参数为预览图片的url
                preloader.destroy();
                preloader = null;
            };
            preloader.load(file.getSource());
        }
    }
</script>